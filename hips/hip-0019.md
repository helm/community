---
hip: 0019
title: "Enable Running Hooks in Parallel"
authors: [ "Michael Morris <michael.morris@est.tech>" ]
created: "2024-06-06"
type: "feature"
status: "draft"
---

## Abstract

Helm hooks are currently executed serially. In many cases there will be no reason why they cannot be run in parallel. Running hooks in parallel can significantly improve install/upgrade times

## Motivation

Decrease install/upgrade times by executing hooks in parallel

## Specification

Only hooks of the same weight may be executed in parallel. The chart designer can specify if hooks will be run in parallel. I am proposing two options, one more fine grained that the other. 

Option 1.
Add a new parameter to the chart metadata of type boolean with name 'runHooksInParallel'.
When set to 'false' (default), the behavior will be as today (hooks run in sequence).
When set to 'true', hooks of the same weight for the chart shall be run in parallel.
In the case of subcharts, hooks of the same weight from different sub charts with 'runHooksInParallel' set to 'true' will be run in parallel. Hooks from subcharts with 'runHooksInParallel' to 'false' shall be run sequentially after hooks of the same weight that are permitted to run in parallel.

Option 2.
Add a new parameter to the chart metadata with name 'runHooksInParallel' that accepts three values - 'false', 'otherChartsOnly' and 'true'.
Behavior for 'true' and 'false' is as per option 1. above.
The value 'otherChartsOnly' is only relevant in the case of subcharts and shall indicate that the hooks belonging to the particular subchart have to be run sequentially but, it is ok for this to happen in parallel with the execution of hooks from other subcharts

For example, given a chart with subcharts as follows:

|Sub chart|Hook|Weight|
|---------|----|------|
|chart A  |H1  |0     |
|         |H2  |1     |
|chart B  |H3  |0     |
|         |H4  |0     |
|         |H5  |1     |
|chart C  |H6  |0     |
|         |H7  |1     |
 

* With 'runHooksInParallel' set as follows:

|chart  |runHooksInParallel|
|-------|------------------|
|chart A|true              |
|chart B|true              |
|chart C|true              |

the execution order of the hooks shall be (hooks in same column are in parallel):

<table>
    <thead>
        <tr>
            <th colspan="2" style="border-style: solid;">Order of Execution</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="2" style="border-style: solid;">-------------->-----------</td>
        </tr>
        <tr>
            <td style="border-style: solid;">H1</td>
            <td style="border-style: solid;">H2</td>
        </tr>
       <tr>
            <td style="border-style: solid;">H3</td>
            <td style="border-style: solid;">H5</td>
        </tr>
        <tr>
            <td style="border-style: solid;">H4</td>
            <td rowspan="2" style="vertical-align: middle;border-style: solid;">H7</td>
        </tr>
        <tr>
            <td style="border-style: solid;">H6</td>
        </tr>
    </tbody>
</table>

i.e. Hooks H1, H3, H4 and H6 all having weight 0 are run in parallel, followed by hooks H2, H5 and H7 (all of which have weight 1)

* With 'runHooksInParallel' set as follows:

|chart  |runHooksInParallel|
|-------|------------------|
|chart A|true              |
|chart B|** false **       |
|chart C|true              |

the execution order of the hooks shall be:

<table>
    <thead>
        <tr>
            <th colspan="5" style="border-style: solid;">Order of Execution</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="5" style="border-style: solid;">---->----->----->---->---</td>
        </tr>
        <tr>
            <td style="text-align:center;border-style: solid;">H1</td>
            <td rowspan="2" style="vertical-align: middle;border-style: solid;">H3</td>
            <td rowspan="2" style="vertical-align: middle;border-style: solid;">H4</td>
            <td style="vertical-align: middle;border-style: solid;">H2</td>
            <td rowspan="2" style="vertical-align: middle;border-style: solid;">H5</td>
        </tr>
       <tr>
            <td style="text-align:center;border-style: solid;">H6</td>
            <td style="vertical-align: middle;border-style: solid;">H7</td>
        </tr>
    </tbody>
</table>

i.e. H3 and H4 are now run sequentially after H1 and H6 because the subchart they belong to has runHooksInParallel set to 'false'. Similarly H5 is now run after H2 and H7

* With 'runHooksInParallel' set as follows:

|chart  |runHooksInParallel    |
|-------|----------------------|
|chart A|true                  |
|chart B|** otherChartsOnly ** |
|chart C|true                  |

the execution order of the hooks shall be:

<table>
    <thead>
        <tr>
            <th colspan="4" style="border-style: solid;">Order of Execution</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="4" style="border-style: solid;">---->------>----->----</td>
        </tr>
        <tr>
            <td colspan="2" style="text-align:center;border-style: solid;">H1</td>
            <td rowspan="1" style="border-style: solid;">H2</td>
            <td rowspan="3" style="vertical-align: middle;border-style: solid;">H5</td>
        </tr>
        <tr>
            <td style="border-style: solid;">H3</td>
            <td style="border-style: solid;">H4</td>
            <td rowspan="2" style="vertical-align: middle;border-style: solid;">H7</td>
        </tr>
       <tr>
            <td colspan="2" style="text-align:center;border-style: solid;">H6</td>
        </tr>
    </tbody>
</table>

i.e. as runHooksInParallel is now set to 'otherChartsOnly' for chart B, H3 and H4 are still run sequentially but in parallel with H1 and H6 which are from different subcharts


### Example Chart

    apiVersion: v1
    kind: Pod
    metadata:
      name: example-chart
      runHooksInParallel: true
    spec:
      ...

## Rationale

While it may be desirable to run hooks in parallel, particularly those of the same weight, doing so by default may cause issues for users depending on the existing serial behavior. Therefore it is proposed to keep the existing serial behavior by default and enable parallel behavior through the chart definition.

Allowing hooks of different weights to be executed in parallel is probably not consistent with the documented behavior of lower weight hooks being executed before higher weighted hooks and, therefore only hooks of the same weight shall be executed in parallel.

Option 2 makes the logic more complex, but allows the chart designer to specify the hooks for a subchart must be run sequentially without blocking the hooks for other subcharts where they are of no significance.

## Backwards compatibility

Proposed solution is fully backwards compatible with no changes in default behavior.

## Security implications

None

## How to teach this

Document in command line help and https://helm.sh/docs/topics/charts_hooks/.

## Reference implementation

PR submitted some time ago: https://github.com/helm/helm/pull/11804
May need to be updated depending on decisions taken on what is proposed here.

## Rejected ideas

Add a flag to control parallel behavior. 
It is the chart developer that will have the knowledge of the application to determine if hooks can be run in parallel rather than the chart installer. Therefore, control should lie in the chart itself rather than the install (etc.) commands

## Open issues

|Issue                                                                                    |Proposal|Decision|
|-----------------------------------------------------------------------------------------|--------|--------|
|Should we allow hooks to be run in parallel                                              |Yes     |        |
|Should the default behavior continue to be to execute in serial                          |Yes     |        |
|Should only hooks of the same weight be executed in parallel                             |Yes     |        |
|Is boolean value ok or should we allow more granularity, i.e. option1 or option 2        |        |

## References

There exists an older closed HIP on hook parallelism, but its focus was on test hooks: https://github.com/helm/community/pull/165