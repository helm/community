---
hip: 9999
title: "Schema Validation with External Dependencies"
authors: [ "Benoit Tigeot <benoit.tigeot@lifen.fr>" ]
created: "2025-10-08"
type: "feature"
status: "draft"
---

## Abstract

A recent change in Helm's JSON schema validation library (see issue helm/helm#31170) has made schema validation stricter, causing failures when schemas contain unresolvable URN or URL references. While the immediate issue can be addressed by making the compiler less strict, it highlights a need for a formal mechanism to resolve schema references within a chart. As discussed during Dev meeting Helm V4 should be stricter on this part. This proposal introduces a method for `values.schema.json` to reference external JSON schema files located within the chart. It suggests the creation of a new file, `schema-dependencies.json`, in the chart's root directory. This file will define mappings from URL prefixes to local chart paths, enabling schema reuse and better organization. This provides a robust, long-term solution for managing schema dependencies.

## Motivation

Currently, `values.schema.json` is self-contained, which limits the ability to reuse common schema definitions across multiple charts. For instance, an organization may have a standard definition for a "CPU" or "memory" resource that they want to use in all of their charts. Without the ability to reference external schemas, chart authors are forced to duplicate these definitions in every chart, leading to inconsistencies and maintenance overhead.

This proposal solves this problem by providing a mechanism to reference external schemas, making it easier to create and maintain complex charts with shared schema definitions.

## Rationale

The primary design goal is to keep schema validation logic, which is optional, separate from the core chart metadata in `Chart.yaml`. A file-based approach provides a clean separation of concerns.

Several approaches were considered:

1.  **Convention-based `schemas` directory**: This approach, while simple, was deemed too implicit and less flexible than an explicit mapping file.

2.  **`schema-dependencies.json` file**: This approach was chosen as it provides an explicit, flexible, and decoupled way to manage schema dependencies. It permit referencing remote additional definition too.

## Specification

A new file named `schema-dependencies.json` will be recognized in the root of a chart. This file will contain a JSON object that maps URL prefixes to local paths within the chart.

**Example `schema-dependencies.json`:**
```json
{
  "common-definitions": "common/definitions.json"
}
```

When this file is present, Helm will parse it before performing schema validation. The mappings will be used to configure the `jsonschema` compiler, allowing it to resolve `$ref` values that use the defined prefixes.

For example, with the mappings above:
- A `$ref` of `"common-definitions#/definitions/memory"` would resolve to the file `common/definitions.json`.

## Backwards compatibility

This is a breaking change in v4. Charts with `values.schema.json` with external requirements but without a `schema-dependencies.json` file will return an error.

## Security implications

To prevent security risks, such as accessing arbitrary files on the filesystem, the paths in `schema-dependencies.json` must be relative and will be constrained to the chart's directory. Any path attempting to traverse outside the chart (e.g., `../...`) will be rejected.

## How to teach this

The Helm documentation will be updated to describe the `schema-dependencies.json` file, its format, and how to use it to reference external schemas in `values.schema.json`. Examples will be provided to illustrate its usage.

## Reference implementation

No reference implementation exists yet. On should be proposed before the draft is accepted.

## Implementation Strategy

The implementation can be localized within the Helm codebase by leveraging the intended extension points of the `jsonschema` library.

1.  **The `jsonschema` Library Supports It**: The `jsonschema` library is designed to be extensible with custom loaders. The library's own command-line tool uses a custom loader to implement its `--map` functionality, which is conceptually identical to what the `schema-dependencies.json` file proposes. We would be using the library as intended. 

2.  **Minimal Changes to Helm**: The implementation would be localized almost entirely within Helm's `pkg/chart/common/util/jsonschema.go` file. The logic would be:
    *   Before compiling the schema, check for `schema-dependencies.json`.
    *   If it exists, parse the mappings.
    *   Create a new custom loader that checks for mapped prefixes and, if a match is found, loads the corresponding local file. If not, it falls back to the default behavior.
    *   Pass this new loader to the `jsonschema.Compiler`.

## Rejected ideas

- **Convention-based `schemas` directory**: This idea was rejected in favor of a more explicit and flexible mapping file.

## Open issues

- https://github.com/helm/helm/issues/31170

## References

- [santhosh-tekuri/jsonschema](https://github.com/santhosh-tekuri/jsonschema)
- [silencing schema loading error](https://github.com/helm/helm/pull/31240)
